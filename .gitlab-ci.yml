# .gitlab-ci.yml (top-level)

include:
  - local: /.gitlab/containerize.gitlab-ci.yml
  - local: /.gitlab/job-rules.gitlab-ci.yml
  - local: /.gitlab/container-scan.gitlab-ci.yml
  - local: /.gitlab/secrets.gitlab-ci.yml
  - local: /.gitlab/promote.gitlab-ci.yml
  - local: /.gitlab/release.gitlab-ci.yml

stages: [build, scan, render, promote, release]

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

# Global defaults (inherited by all jobs unless overridden)
default:
  interruptible: true

variables:
  PUSH_FEATURE_BRANCH: "true"


render:helm:
  image: alpine/helm:3
  stage: render
  needs: ["build:docker"]
  dependencies: ["build:docker"]
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(dev|test|int|prod)$/'
    - if: '$CI_COMMIT_TAG'   # run on tags too
  before_script:
    - set -eu
    - source docker.env
    - CHART_DIR="${CHART_DIR:-helm/$CI_PROJECT_NAME}"
  script: |
    set -eu
    helm template "$CI_PROJECT_NAME" "$CHART_DIR" \
      --set image.repository="$DOCKER_IMAGE_REPO" \
      --set image.digest="$DOCKER_IMAGE_DIGEST" \
      --set image.tag="$DOCKER_IMAGE_TAG" \
      > "rendered-${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}.yaml"
    echo "Rendered: rendered-${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}.yaml"
  artifacts:
    paths:
      - rendered-*.yaml
    expire_in: 30 days
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://$CI_COMMIT_REF_NAME.swf.local
