# -------------------------------------------------------------------
# Example CI Pipeline
# -------------------------------------------------------------------
include:
  - local: '.gitlab/job-rules.gitlab-ci.yml'     # âžŠ rules first
  - local: '.gitlab/secrets.gitlab-ci.yml'       # scans can !reference rules now
  - local: '.gitlab/docker.gitlab-ci.yml'
  - local: '.gitlab/deploy.gitlab-ci.yml'
  - local: '.gitlab/release.gitlab-ci.yml'

stages: [verify, build, scan, deploy, release]

variables:
  APP_NAME: templates
  DEV_TAG_SUFFIX: "dev"
  TEST_TAG_SUFFIX: "test"
  INT_TAG_SUFFIX:  "int"
  PROD_TAG_SUFFIX: "prod"
  MR_TAG_SUFFIX:   "mr"
  FEATURE_TAG_SUFFIX: "feat"
  PUSH_ON_FEATURE: "false"

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - when: never

# ---------------------------
# Build
# ---------------------------
build:docker:
  stage: build
  interruptible: true
  extends: .build-common
  rules: !reference [.rule:build-matrix, rules]


debug:vars:
  stage: verify
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - echo "CI_COMMIT_TAG=$CI_COMMIT_TAG"
    - echo "RELEASE_IMAGE=${RELEASE_IMAGE:-}"
    - echo "PUSH_IMAGE=${PUSH_IMAGE:-}"
    - echo "TAG_SUFFIX=${TAG_SUFFIX:-}"
    - echo "IMAGE_TAG=${IMAGE_TAG:-}"



