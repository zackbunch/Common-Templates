.build-dind:
  # Pinning Docker version for consistency across environments
  image: docker:24.0.5
  variables:
    DIND_IMAGE:       docker:24.0.5-dind
    DOCKER_DRIVER:    overlay2
    DOCKER_TLS_CERTDIR: ""
  services:
    - name: $DIND_IMAGE
      alias: docker
  before_script:
    - set -euxo pipefail
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  after_script:
    - docker logout "$CI_REGISTRY" || true

.build-common:
  script:
    - echo "Starting Docker build for $APP_NAME"

    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        IMAGE_TAG="$CI_COMMIT_TAG"
        echo "Detected tag: using IMAGE_TAG=$IMAGE_TAG"
      else
        IMAGE_TAG="$SHORT_SHA"
        echo "No tag detected: using IMAGE_TAG=$IMAGE_TAG"
      fi

    - echo "Building image $IMAGE_ENV_PATH:$IMAGE_TAG"
    - docker build --pull -t "$IMAGE_ENV_PATH:$IMAGE_TAG" .

    - |
      if [ "${PUSH_LATEST:-true}" != "false" ]; then
        echo "Tagging image as latest: $IMAGE_ENV_PATH:latest"
        docker tag "$IMAGE_ENV_PATH:$IMAGE_TAG" "$IMAGE_ENV_PATH:latest"
      else
        echo "PUSH_LATEST=false — skipping latest tag."
      fi

    - |
      if [ "$PUSH_IMAGE" = "true" ]; then
        echo "PUSH_IMAGE=true — Pushing image $IMAGE_TAG to registry..."
        docker push "$IMAGE_ENV_PATH:$IMAGE_TAG"

        if [ "${PUSH_LATEST:-true}" != "false" ]; then
          docker push "$IMAGE_ENV_PATH:latest"
          echo "Image pushed: $IMAGE_ENV_PATH:latest"
        fi

        echo "Image pushed: $IMAGE_ENV_PATH:$IMAGE_TAG"

        DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE_ENV_PATH:$IMAGE_TAG" || true)
        echo "Image digest: $DIGEST"
        echo "IMAGE_DIGEST=$DIGEST" >> image-digest.env
      else
        echo "PUSH_IMAGE=false — skipping docker push."
        echo "Built image is available locally but was not pushed."
        echo "IMAGE_DIGEST=skipped" >> image-digest.env
      fi

    - echo "Final local images for $APP_NAME:"
    - docker images "$IMAGE_ENV_PATH" --format '{{.Repository}}:{{.Tag}} ({{.Size}})'

  artifacts:
    reports:
      dotenv: image-digest.env