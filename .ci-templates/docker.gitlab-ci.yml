.build-dind:
  image: docker:24.0.5
  variables:
    DIND_IMAGE:       docker:24.0.5-dind
    DOCKER_DRIVER:    overlay2
    DOCKER_TLS_CERTDIR: ""
  services:
    - name: $DIND_IMAGE
      alias: docker
  before_script:
    - set -euxo pipefail
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  after_script:
    - docker logout "$CI_REGISTRY" || true

.build-common:
  script:
    - docker build -t "$IMAGE_ENV_PATH:$SHORT_SHA" .
    - docker tag "$IMAGE_ENV_PATH:$SHORT_SHA" "$IMAGE_ENV_PATH:latest"
    - if [ "$PUSH_IMAGE" = "true" ]; then
        docker push "$IMAGE_ENV_PATH:$SHORT_SHA";
        docker push "$IMAGE_ENV_PATH:latest";
      fi